import { genapi, pollRequestStatus } from './client';
import { getCurrentModelConfig } from './models';

export interface SongFormData {
  voice: 'male' | 'female';
  aboutWho: string;
  aboutWhat: string;
  genre: string;
  style: string;
  customStyle?: string;
  occasion: string;
  customOccasion?: string;
  mustInclude?: string;
  email: string;
}

function createSongPrompt(formData: SongFormData): string {
  const genre = formData.genre;
  const occasion = formData.customOccasion || formData.occasion;

  return `Ты — профессиональный сонграйтер уровня "Грэмми", пишущий на русском языке. 
Твоя задача: создать текст, который Suno AI превратит в музыкальный шедевр.
КОНТЕКСТ ЗАДАНИЯ: К тебе обратился клиент нашего сервиса. Ниже — данные из его анкеты. 
Твой профессионализм заключается в том, чтобы превратить эти личные факты в хитовую композицию, сохранив 100% точность деталей и желаемое настроение.
Нужно адаптировать лексику, ритм и подачу текста под выбранный жанр музыки и стиль текста. 
Текст должен звучать органично для выбранного музыкального направления. Повод написания песни нужно также учитывать.

────────────────────────
ИСХОДНЫЕ ДАННЫЕ ЗАКАЗА:
────────────────────────

О КОМ ПЕСНЯ:
${formData.aboutWho}

О ЧЁМ ПЕСНЯ:
${formData.aboutWhat}

ПОВОД:
${occasion}

ЖАНР МУЗЫКИ:
${genre}

СТИЛЬ ТЕКСТА:
${formData.style}

ГОЛОС ИСПОЛНИТЕЛЯ:
${formData.voice === 'male' ? 'Мужской' : 'Женский'}

${formData.mustInclude ? `ОБЯЗАТЕЛЬНЫЕ ФРАЗЫ (включить дословно): ${formData.mustInclude}` : ''}

────────────────────────
РАСШИФРОВКА СТИЛЯ ТЕКСТА (используй как ориентир)
────────────────────────

Если стиль:
- Весёлая → лёгкая, живая, позитивная, с юмором
- Душевная → тёплая, искренняя, эмоциональная
- Прожарка → ироничная, дерзкая, но ДОБРАЯ, без злобы
- Романтичная → нежная, чувственная
- Мотивирующая → вдохновляющая, энергичная
- Ностальгическая → тёплая, с ощущением воспоминаний
- Пользовательский стиль → адаптируйся к описанию

────────────────────────
РАСШИФРОВКА ЖАНРА (обязательно учитывай)
────────────────────────

- Новогодний поп → празднично, тепло, светло
- Классический поп → запоминающийся, универсальный
- Рэп → ритмично, разговорно, с внутренними рифмами
- Рок → энергично, мощно
- Шансон → просто, душевно, жизненно
- Джаз → мягко, образно, атмосферно
- Электро → современно, динамично
- Блюз → чувственно, с тягой и паузами
- Кантри → истории, простота, искренность
- Акустика → камерно, интимно

────────────────────────
СТРУКТУРА ПЕСНИ (ОБЯЗАТЕЛЬНО)
────────────────────────

Используй ТОЛЬКО теги Suno:

[Intro] — опционально  
[Verse 1] — 4–6 строк  
[Chorus] — 3–4 строки (запоминающийся)  
[Verse 2] — 4–6 строк  
[Chorus] — повтор  
[Bridge] — 2–4 строки (опционально)  
[Chorus] — финальный  
[Outro] — опционально  
[End] — ОБЯЗАТЕЛЬНО В КОНЦЕ

────────────────────────
РИТМ И МУЗЫКАЛЬНОСТЬ (КРИТИЧНО ДЛЯ SUNO)
────────────────────────

- Внутри одного куплета строки должны быть сопоставимой длины
- Избегай резких скачков длины строк без художественной цели
- Короткие строки → распевность
- Длинные строки → речитатив (особенно для рэпа)

────────────────────────
ПРИПЕВ (ОЧЕНЬ ВАЖНО)
────────────────────────

- Припев должен содержать ЗАПОМИНАЮЩИЙСЯ ХУК (но не обязательно, зависит от жанра)
  (ключевая фраза или образ)
- Хук может повторяться 2–3 раза (если это нужно)
- Припев — эмоциональный центр песни

────────────────────────
ЭМОЦИОНАЛЬНАЯ ДИНАМИКА
────────────────────────

- Эмоция должна нарастать к финальному припеву
- Допустим осознанный повтор слов и строк, если это усиливает эффект

────────────────────────
ПЕРСОНАЛИЗАЦИЯ
────────────────────────

- Используй КОНКРЕТНЫЕ сцены и детали  
  (ситуации, привычки, действия, моменты из жизни)
- Вплетай информацию естественно, без перечислений
- Куплеты должны отличаться по смыслу  
  (разные стороны человека / разные моменты)

────────────────────────
ДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ
────────────────────────
- Пиши текст так, чтобы выбранный голос в исходных данных (мужской/женский) звучал естественно и соответствовал эмоциональной окраске песни
- Соблюдай характерные черты жанра: ритм, рифмовку, словарь, эмоциональные акценты
- Внутри одного куплета строки должны быть сопоставимой длины
- Избегай резких скачков длины строк без художественной цели
- Куплеты должны раскрывать одну тему с разных сторон, 
  не повторяя одни и те же мысли
- Допустим осознанный повтор строк или слов,
  если это усиливает музыкальность и эмоцию
- ДЕТАЛИ: Вплетай факты о человеке в метафоры. (если это возможно)


────────────────────────
 ОГРАНИЧЕНИЯ
────────────────────────

- старайся не использовать абстрактные клише:
  звёзды, судьба, путь, навсегда и подобные (если этого не сказано в исходном задании или не требует ситуация)
- НЕ используй нецензурную лексику
- Если в исходных данных есть мат — замени его
  на яркие эмоциональные синонимы
- старайся избегать книжных и перегруженных формулировок (если этого не требует задача) 

────────────────────────
ЯЗЫК И ВОКАЛ (ПРАВИЛА SUNO)
────────────────────────

1. БУКВА Ё  
   — Если по правилам русского языка нужна «Ё», пиши ТОЛЬКО «Ё», а не «Е»

2. АКЦЕНТЫ  
   — Можно выделять слова КАПСОМ для вокального акцента (если они будут нужны в тексте)

3. РАСПЕВЫ  
   — Используй дефисы: о-о-о, а-а-а, е-е-е (если они нужны)

4. ВОКАЛИЗЫ  
   — У-у-у… А-а-а! О-о-о… (если будут нужны) 

5. БЭК-ВОКАЛ  
   — Используй круглые скобки: (со мной), (эй!)  (если нужны в тексте)

6. ПУНКТУАЦИЯ  (если нужна в тексте)
   — … ! ? ?! !.. — для передачи интонации

────────────────────────
ДЛИНА
────────────────────────

- Общая длина: 20–30 строк (без тегов)
- Куплеты: 4–6 строк
- Припевы: 3–4 строки
- Бридж: 2–4 строки

────────────────────────
ФОРМАТ ВЫВОДА (КРИТИЧНО)
────────────────────────

⚠️ Верни ТОЛЬКО текст песни  
⚠️ БЕЗ комментариев, пояснений и вступлений  
⚠️ ТОЛЬКО теги Suno и текст  
⚠️ Формат должен быть готов к прямой вставке в Suno

НАЧИНАЙ ГЕНЕРАЦИЮ ТЕКСТА ПЕСНИ СЕЙЧАС`;
}

async function generateWithChatGPT(prompt: string): Promise<number> {
  try {
    const response = await genapi.post('/networks/gpt-5-2', {
      messages: [
        {
          role: 'system',
          content: 'Ты — профессиональный автор песен на русском языке для Suno AI. Отвечаешь ТОЛЬКО текстом песни с тегами, без комментариев.'
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      max_tokens: 4096,
      temperature: 0.9,
      top_p: 1,
    });

    return response.data.request_id;
  } catch (error) {
    if (error && typeof error === 'object' && 'response' in error) {
      const axiosError = error as { response?: { data?: unknown }; message?: string };
      console.error('ChatGPT error:', axiosError.response?.data || axiosError.message);
    } else {
      console.error('ChatGPT error:', error);
    }
    throw new Error('Ошибка генерации текста');
  }
}

async function generateWithClaude(prompt: string): Promise<number> {
  const response = await genapi.post('/networks/claude-sonnet-3-5', {
    prompt: prompt,
    max_tokens: 4096,
    temperature: 0.9,
  });
  return response.data.request_id;
}

async function generateWithGemini(prompt: string): Promise<number> {
  const response = await genapi.post('/networks/gemini-pro', {
    prompt: prompt,
    max_tokens: 4096,
  });
  return response.data.request_id;
}

export async function generateSongText(formData: SongFormData): Promise<string> {
  const prompt = createSongPrompt(formData);
  const modelConfig = getCurrentModelConfig();

  let requestId: number;

  switch (modelConfig.networkId) {
    case 'gpt-5-2':
      requestId = await generateWithChatGPT(prompt);
      break;
    case 'claude-sonnet-3-5':
      requestId = await generateWithClaude(prompt);
      break;
    case 'gemini-pro':
      requestId = await generateWithGemini(prompt);
      break;
    default:
      throw new Error(`Неизвестная модель: ${modelConfig.networkId}`);
  }

  const result = await pollRequestStatus(requestId, 30, 3000);

  // Для ChatGPT результат возвращается как строка
  if (typeof result === 'string') {
    return result;
  }

  // Новый формат ChatGPT - объект с message.content
  if (result && typeof result === 'object') {
    // Формат: { index: 0, message: { role: 'assistant', content: '...' }, ... }
    if ('message' in result) {
      const message = (result as { message?: { content?: unknown } }).message;
      if (message && typeof message.content === 'string') {
        return message.content;
      }
    }

    // Альтернативный формат с content напрямую
    if ('content' in result) {
      const content = (result as { content: unknown }).content;
      if (typeof content === 'string') {
        return content;
      }
    }
  }

  // Для отладки выведем что получили
  console.error('Unexpected result format from AI:', JSON.stringify(result, null, 2));
  throw new Error('Неожиданный формат ответа от AI модели');
}
