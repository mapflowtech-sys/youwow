# Инструкция для администратора партнёрской системы YouWow

## Введение

Эта инструкция описывает, как управлять партнёрской программой через админ-панель YouWow.

---

## Доступ к админ-панели

Админ-панель доступна по адресу:
```
https://youwow.ru/admin/partners
```

---

## Основные функции

### 1. Просмотр списка партнёров

На главной странице админ-панели отображается список всех партнёров с информацией:
- **Название партнёра**
- **ID партнёра**
- **Статус** (Активен / Неактивен / В архиве)
- **Переходы** — количество кликов по партнёрской ссылке
- **Покупки** — количество конверсий (оплаченных заказов)
- **Конверсия** — процент покупок от переходов
- **К выплате** — сумма ожидающих выплаты комиссий
- **Комиссия** — размер комиссии партнёра за одну продажу

**Фильтры:**
- **Активные** — отображаются партнёры со статусом "Активен" или "Неактивен"
- **Архив** — партнёры в архиве (скрыты из основного списка)

**Сортировка:**
- По умолчанию список сортируется по дате создания (новые сверху)
- Можно кликнуть на заголовки столбцов для сортировки

---

### 2. Создание нового партнёра

**Шаги:**

1. Нажмите кнопку **"Создать партнёра"** в правом верхнем углу
2. Заполните форму:
   - **ID партнёра** (обязательно) — уникальный идентификатор, только латиница, цифры и дефисы (например, `blogopodarki`, `dns-shop`)
   - **Название** (обязательно) — отображаемое имя партнёра (например, "DNS Shop")
   - **Сайт** (опционально) — URL сайта партнёра
   - **Реквизиты для выплат** (опционально) — номер карты, счёт и т.д.
   - **Комиссия** (обязательно) — сумма в рублях за каждую продажу (по умолчанию 200₽)
   - **Статус** — Активен / Неактивен / В архиве (по умолчанию "Активен")
   - **Заметки** (опционально) — любые дополнительные заметки

3. Нажмите **"Создать"**

**После создания:**
- Партнёр появится в списке
- Партнёрская ссылка будет доступна: `https://youwow.ru/song?partner=ID`
- Личный кабинет партнёра: `https://youwow.ru/partners/ID`

---

### 3. Просмотр статистики партнёра

**Шаги:**

1. Кликните на строку партнёра в таблице
2. Откроется детальная страница со статистикой:

**KPI карточки:**
- **Переходы** — общее количество кликов
- **Покупки** — количество конверсий и процент конверсии
- **Заработано** — общая сумма комиссий (всего времени)
- **К выплате** — сумма невыплаченных комиссий

**График:**
- Переходы и покупки по дням
- Можно выбрать период: 7 дней, 30 дней, 90 дней

**Таблица конверсий:**
- Последние 20 конверсий с информацией:
  - Дата и время покупки
  - Тип сервиса (Песня / Санта / и т.д.)
  - Сумма заказа
  - Комиссия партнёра
  - Статус выплаты (Ожидает / Выплачено)
  - ID заказа

**Раздел "Настройки":**
- Комиссия за продажу
- Сайт партнёра (если указан)
- Реквизиты (если указаны)

---

### 4. Редактирование партнёра

**Шаги:**

1. Откройте страницу партнёра (кликнув на него в списке)
2. В разделе **"Настройки"** нажмите кнопку **"Редактировать"**
3. Измените нужные поля:
   - Название
   - Сайт
   - Комиссия за продажу
   - Реквизиты для выплат
   - Заметки
4. Нажмите **"Сохранить"**

**Примечание:** ID партнёра изменить нельзя.

---

### 5. Управление статусом партнёра

На странице партнёра доступны следующие действия:

#### Активировать / Деактивировать

**Активный партнёр:**
- Отображается в списке "Активные"
- Партнёрская ссылка работает
- Конверсии отслеживаются

**Неактивный партнёр:**
- Отображается в списке "Активные" (но с пометкой "Неактивен")
- Партнёрская ссылка НЕ работает (клики не отслеживаются)
- Используется, если партнёр временно не работает

**Как изменить:**
1. Нажмите кнопку **"Деактивировать"** или **"Активировать"**
2. Подтвердите действие

#### Архивировать

**Архивный партнёр:**
- Скрыт из списка "Активные"
- Отображается только в разделе "Архив"
- Партнёрская ссылка продолжает работать (конверсии отслеживаются)
- Используется для партнёров, которые больше не активны, но могут иметь старые переходы

**Как архивировать:**
1. Нажмите кнопку **"В архив"**
2. Подтвердите действие

**Как восстановить из архива:**
1. Перейдите во вкладку **"Архив"**
2. Кликните на партнёра
3. Нажмите кнопку **"Восстановить"**
4. Партнёр вернётся в статус "Активен"

---

### 6. Выплата комиссий партнёру

Когда у партнёра накапливается сумма "К выплате" > 0, появляется кнопка **"Отметить выплату"**.

**Шаги:**

1. Откройте страницу партнёра
2. Нажмите кнопку **"Отметить выплату"** (справа от кнопки "Редактировать")
3. Откроется модальное окно:
   - **Партнёр** — название партнёра
   - **Период выплаты** — дата начала и конца периода (по умолчанию: с начала месяца до сегодня)
   - **Сумма** — автоматически рассчитывается на основе невыплаченных конверсий за период
   - **Способ оплаты** — СБП, Карта и т.д. (опционально)
   - **Заметки** — любые дополнительные заметки (опционально)

4. Проверьте период и сумму
5. Нажмите **"Подтвердить выплату"**

**Что происходит после подтверждения:**
- Создаётся запись о выплате в таблице `partner_payouts`
- Все конверсии за указанный период помечаются как "Выплачено" (`is_paid_out = true`)
- Сумма "К выплате" уменьшается
- Сумма "Выплачено" увеличивается
- В таблице конверсий статус меняется на "Выплачено"

**Важно:**
- Выплату нужно произвести вручную (перевести деньги партнёру)
- Система только отмечает, что выплата произведена
- После отметки выплаты отменить действие нельзя (только вручную в Supabase)

---

## Работа с базой данных (Supabase)

### Таблицы партнёрской системы

1. **partners** — список партнёров
   - `id` (PK) — уникальный ID партнёра
   - `name` — название
   - `website`, `payment_info`, `notes` — дополнительная информация
   - `commission_rate` — комиссия в рублях
   - `status` — статус (active/inactive/archived)
   - `created_at` — дата создания

2. **partner_clicks** — клики по партнёрским ссылкам
   - `id` (PK)
   - `partner_id` (FK → partners)
   - `session_id` — уникальный ID сессии
   - `clicked_at` — дата и время клика
   - `ip_address`, `user_agent`, `referrer` — информация о клике

3. **partner_conversions** — конверсии (покупки)
   - `id` (PK)
   - `partner_id` (FK → partners)
   - `session_id` — связь с кликом
   - `order_id` (FK → orders)
   - `service_type` — тип сервиса (song, santa)
   - `amount` — сумма заказа
   - `commission` — комиссия партнёра
   - `is_paid_out` — выплачена ли комиссия
   - `converted_at` — дата покупки

4. **partner_payouts** — история выплат
   - `id` (PK)
   - `partner_id` (FK → partners)
   - `amount` — сумма выплаты
   - `conversions_count` — количество конверсий
   - `period_start`, `period_end` — период
   - `payment_method`, `notes` — дополнительная информация
   - `paid_at` — дата выплаты

### Просмотр данных в Supabase

1. Откройте Supabase: https://supabase.com/dashboard
2. Выберите проект YouWow
3. Перейдите в **Table Editor**
4. Выберите нужную таблицу

**Полезные запросы:**

- Все клики партнёра:
  ```sql
  SELECT * FROM partner_clicks WHERE partner_id = 'test-partner1' ORDER BY clicked_at DESC;
  ```

- Все конверсии партнёра:
  ```sql
  SELECT * FROM partner_conversions WHERE partner_id = 'test-partner1' ORDER BY converted_at DESC;
  ```

- Невыплаченные конверсии:
  ```sql
  SELECT * FROM partner_conversions WHERE partner_id = 'test-partner1' AND is_paid_out = false;
  ```

---

## Как общаться с Claude Code для изменений

### Общие правила

1. **Будьте конкретны** — чётко опишите, что нужно изменить
2. **Укажите файлы** — если знаете, какие файлы затронуты
3. **Приводите примеры** — покажите, как должно работать
4. **Проверяйте после изменений** — протестируйте функционал

### Примеры запросов

#### Изменение комиссии по умолчанию

**Плохо:**
```
Измени комиссию
```

**Хорошо:**
```
Измени комиссию по умолчанию с 200₽ на 250₽ при создании нового партнёра.
Файл: app/api/admin/partners/create/route.ts, строка 32
```

#### Добавление нового поля

**Плохо:**
```
Добавь телефон партнёра
```

**Хорошо:**
```
Добавь поле "Телефон" для партнёра:
1. В таблицу partners в Supabase добавь колонку phone (TEXT, nullable)
2. В типы (types/affiliate.ts) добавь phone?: string
3. В форму создания партнёра (CreatePartnerModal.tsx)
4. В форму редактирования (EditPartnerModal.tsx)
5. В отображение настроек (PartnerStats.tsx)
```

#### Изменение логики выплат

**Плохо:**
```
Сделай минимальную сумму выплаты
```

**Хорошо:**
```
Добавь проверку минимальной суммы выплаты:
- Если сумма "К выплате" < 1000₽, кнопка "Отметить выплату" должна быть неактивна
- Покажи подсказку: "Минимальная сумма для выплаты: 1000₽"
- Файл: app/admin/partners/components/PartnerStats.tsx, строка 309
```

#### Изменение дизайна

**Плохо:**
```
Сделай красивее
```

**Хорошо:**
```
Измени цвет кнопки "Отметить выплату":
- Вместо зелёного (severity="success") сделай фиолетовый (используй Tailwind класс bg-purple-500)
- Файл: app/admin/partners/components/PartnerStats.tsx, строка 310-315
```

### Типичные задачи и как их формулировать

#### 1. Изменение текста/переводов

```
Измени текст кнопки "Отметить выплату" на "Выплатить комиссию"
Файл: app/admin/partners/components/PartnerStats.tsx, строка 311
```

#### 2. Добавление валидации

```
Добавь валидацию при создании партнёра:
- ID должен быть не короче 3 символов
- Название не короче 2 символов
- Комиссия должна быть > 0
Файл: app/api/admin/partners/create/route.ts
```

#### 3. Изменение форматирования

```
Измени формат отображения даты в таблице конверсий:
Вместо "06.01.2026, 15:30" показывай "6 января 2026, 15:30"
Файл: app/admin/partners/components/PartnerStats.tsx, строка 366-372
```

#### 4. Добавление фильтров

```
Добавь фильтр по статусу выплаты в таблице конверсий:
- Dropdown с вариантами: "Все", "Ожидает выплаты", "Выплачено"
- По умолчанию "Все"
- Фильтр должен работать на клиентской стороне
```

#### 5. Экспорт данных

```
Добавь кнопку "Экспорт в Excel" на странице партнёра:
- Экспортировать все конверсии в .xlsx файл
- Колонки: Дата, Сервис, Сумма, Комиссия, Статус, ID заказа
- Использовать библиотеку xlsx (если её нет, установи)
```

### Что делать при ошибках

1. **Скопируйте полный текст ошибки** — не пересказывайте, а копируйте
2. **Укажите, где произошла** — при деплое, в браузере, в консоли
3. **Опишите, что делали** — какие действия привели к ошибке

**Пример:**
```
При деплое получил ошибку:

ERROR: Type 'string | undefined' is not assignable to type 'string'
File: app/admin/partners/components/EditPartnerModal.tsx, line 45

Я пытался добавить новое поле "phone" в форму редактирования
```

---

## Тестирование партнёрской системы

### Полный сценарий тестирования

См. инструкцию в файле: `docs/TESTING_INSTRUCTIONS.md`

---

## Частые вопросы

### Как изменить cookie для отслеживания с 30 дней на другой период?

```
Измени срок хранения партнёрской cookie с 30 дней на 60 дней.
Файл: middleware.ts, строка где устанавливается maxAge cookie
```

### Как добавить email-уведомления о новых конверсиях?

```
Добавь отправку email партнёру при новой конверсии:
1. После создания записи в partner_conversions
2. Отправлять на email, который хранится в новом поле partners.email
3. Шаблон письма: "У вас новая конверсия! Сумма: {amount}₽, комиссия: {commission}₽"
```

### Как настроить автоматические выплаты?

```
Это сложная задача, которая требует:
1. Интеграции с платёжной системой (ЮKassa, CloudPayments)
2. API для автоматических выплат
3. Проверки лимитов и безопасности

Лучше обсудить это отдельно и поэтапно внедрять.
```

---

## Резервное копирование

**Важно:** Регулярно делайте backup базы данных!

1. Откройте Supabase Dashboard
2. Settings → Database → Backups
3. Включите автоматические бэкапы

**Для ручного экспорта:**
```sql
-- SQL для экспорта партнёрских данных
SELECT * FROM partners;
SELECT * FROM partner_clicks;
SELECT * FROM partner_conversions;
SELECT * FROM partner_payouts;
```

---

## Безопасность

1. **Не передавайте доступы к админ-панели** третьим лицам
2. **Регулярно проверяйте партнёрские ссылки** на предмет злоупотреблений
3. **Мониторьте аномальную активность** (слишком много кликов без конверсий)
4. **Проверяйте реквизиты** перед выплатами

---

**Если возникли вопросы — обращайтесь к разработчику или консультируйтесь с Claude Code!**
