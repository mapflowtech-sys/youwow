# Исправление бага: Заказы не завершались после оплаты

## Проблема

После успешной оплаты через виджет ЮKassa:
1. ❌ Заказ оставался в статусе `pending` (не переходил в `processing` → `completed`)
2. ❌ Песня не генерировалась (хотя в Gen-API треки были готовы)
3. ❌ Email с готовой песней не отправлялся
4. ❌ Пользователь видел страницу "Создаём вашу песню..." бесконечно

## Причина

В компоненте `PaymentWidget.tsx` после успешной оплаты:
- Виджет срабатывал событие `'success'`
- Происходило перенаправление на `/order/[id]`
- **НО:** Не вызывался endpoint `/api/song/process` для запуска генерации

Генерация должна была запускаться через webhook от ЮKassa → `/api/payment/yookassa/webhook` → `/api/song/process`.

**Проблема:** В локальной разработке (localhost) webhooks от ЮKassa НЕ приходят (по соображениям безопасности).

## Решение

Добавлен **прямой вызов** `/api/song/process` в обработчик успешной оплаты виджета:

```typescript
widget.on('success', async () => {
  // Триггерим генерацию сразу после успешной оплаты
  await fetch('/api/song/process', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ orderId: orderId }),
  });

  // Затем перенаправляем на страницу заказа
  router.push(`/order/${orderId}`);
});
```

## Исправленные файлы

- `components/PaymentWidget.tsx` - добавлен вызов `/api/song/process` после успешной оплаты

## Коммиты

- `190bd49` - fix: Trigger song generation immediately after successful payment via widget

## Тестирование

### Как протестировать на production:

1. Откройте `/test` на боевом сервере
2. Заполните форму и оплатите тестовой картой:
   - **Номер:** 5555 5555 5555 4477
   - **Срок:** 01/30
   - **CVC:** 123
   - **3-D Secure:** 123

3. После успешной оплаты вы должны увидеть:
   - ✅ Анимация "Оплата прошла успешно!"
   - ✅ Переход на `/order/[id]`
   - ✅ Статус "Создаём вашу песню" с музыкальными фактами
   - ✅ Через 3-5 минут статус изменится на "Ваша песня готова!"
   - ✅ Появится аудиоплеер и кнопка скачивания
   - ✅ Email с песней придёт на указанный адрес

### Проверка старого заказа

Если у вас есть "застрявший" заказ (например, `7edaad11-8942-4e69-abaf-3a3998d11115`):

```bash
# Запустите dev-сервер
npm run dev

# В другом терминале триггерните генерацию вручную
npx tsx trigger-generation.ts 7edaad11-8942-4e69-abaf-3a3998d11115

# Проверьте статус через несколько минут
npx tsx check-order.ts 7edaad11-8942-4e69-abaf-3a3998d11115
```

## Дополнительные заметки

### Почему webhook не работал в dev?

ЮKassa отправляет webhooks только на публичные HTTPS URL. Локальный `http://localhost:3000` недоступен для внешних серверов.

**Решения для dev:**
1. ✅ **Текущее** - прямой вызов `/api/song/process` из виджета (работает и в dev, и в production)
2. Использовать ngrok/localtunnel для туннелирования localhost
3. Использовать тестовый домен с SSL

### Почему это безопасно?

Вызов `/api/song/process`:
1. Проверяет статус заказа (`pending` или `paid`)
2. Не позволяет повторную генерацию для уже обработанных заказов
3. Webhook от ЮKassa всё равно продублирует запуск (безопасно, т.к. есть проверка статуса)

### Production поведение

На production:
- Webhook от ЮKassa **ПРИДЁТ** (т.к. есть публичный HTTPS URL)
- Прямой вызов из виджета **ТАКЖЕ СРАБОТАЕТ**
- Второй вызов будет проигнорирован (заказ уже в статусе `processing`)
- Результат: генерация запустится быстрее (не нужно ждать webhook)

## Дата исправления

30.12.2025, 03:30 МСК
