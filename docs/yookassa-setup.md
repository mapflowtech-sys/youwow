# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ YooKassa

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

1. ‚úÖ –°–æ–∑–¥–∞–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä YooKassa (`lib/payment/providers/yookassa.ts`)
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env.local`
3. ‚úÖ –°–æ–∑–¥–∞–Ω webhook endpoint (`/api/payment/yookassa/webhook`)
4. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω config.ts —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π YooKassa
5. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ü–µ–Ω–∞: **590 —Ä—É–±–ª–µ–π**

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ YooKassa

### –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç: https://yookassa.ru/my/
2. –û—Ç–∫—Ä–æ–π—Ç–µ —Ä–∞–∑–¥–µ–ª **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Üí HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
3. –£–∫–∞–∂–∏—Ç–µ URL –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
   ```
   https://yourdomain.com/api/payment/yookassa/webhook
   ```
   –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok (—Å–º. –Ω–∏–∂–µ)

4. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
   - ‚úÖ `payment.succeeded` - –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω
   - ‚úÖ `payment.canceled` - –ø–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω
   - ‚ö†Ô∏è `payment.waiting_for_capture` - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –¥–≤—É—Ö—Å—Ç–∞–¥–∏–π–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏

5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–í `.env.local` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–∫–∞–∑–∞–Ω—ã:
```env
YOOKASSA_SHOP_ID=1229933
YOOKASSA_SECRET_KEY=live_4mvUbA8fN9DWepS5Z_3qPAfNX1q6osihl6LYqbvTYy8
PAYMENT_PROVIDER=yookassa
```

## üß™ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å ngrok

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ngrok (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)

1. –°–∫–∞—á–∞–π—Ç–µ: https://ngrok.com/download
2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ PATH

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
   ```bash
   npm run dev
   ```

2. –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç–µ ngrok:
   ```bash
   ngrok http 3000
   ```

3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ HTTPS URL (–Ω–∞–ø—Ä–∏–º–µ—Ä: `https://abc123.ngrok.io`)

4. –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ YooKassa —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ webhook URL:
   ```
   https://abc123.ngrok.io/api/payment/yookassa/webhook
   ```

5. –û–±–Ω–æ–≤–∏—Ç–µ `.env.local`:
   ```env
   NEXT_PUBLIC_APP_URL=https://abc123.ngrok.io
   ```

6. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

## üéØ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞

### –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

YooKassa –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã:

**–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞:**
- –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: `5555 5555 5555 4444`
- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: –ª—é–±–∞—è –¥–∞—Ç–∞ –∏–∑ –±—É–¥—É—â–µ–≥–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `12/25`)
- CVC: –ª—é–±—ã–µ 3 —Ü–∏—Ñ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `123`)
- –ò–º—è: –ª—é–±–æ–µ

**–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞:**
- –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: `4444 4444 4444 4448`

### –°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—á–µ—Ä–µ–∑ ngrok URL –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ)
2. –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–µ—Å–Ω–∏
3. –ù–∞–∂–º–∏—Ç–µ "–û–ø–ª–∞—Ç–∏—Ç—å"
4. –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É YooKassa
5. –í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
6. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ–ø–ª–∞—Ç—É
7. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã:
   - –í—ã –≤–µ—Ä–Ω–µ—Ç–µ—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
   - Webhook –æ–±–Ω–æ–≤–∏—Ç —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –≤ –ë–î
   - –ó–∞–ø—É—Å—Ç–∏—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Å–Ω–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook –≤ –ª–æ–≥–∞—Ö

–í –∫–æ–Ω—Å–æ–ª–∏ Next.js –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
[YooKassa Webhook] Received webhook
[YooKassa Webhook] Verified data: { orderId: '...', status: 1, ... }
[YooKassa Webhook] Order updated successfully
[YooKassa Webhook] Song processing triggered successfully
```

## üöÄ Production deployment

### –ù–∞ production —Å–µ—Ä–≤–µ—Ä–µ

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
   ```env
   YOOKASSA_SHOP_ID=1229933
   YOOKASSA_SECRET_KEY=live_4mvUbA8fN9DWepS5Z_3qPAfNX1q6osihl6LYqbvTYy8
   PAYMENT_PROVIDER=yookassa
   NEXT_PUBLIC_APP_URL=https://yourdomain.com
   ```

2. –í YooKassa —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ production webhook URL:
   ```
   https://yourdomain.com/api/payment/yookassa/webhook
   ```

3. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É:
   - HTTPS (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
   - –ü–æ—Ä—Ç 443 –∏–ª–∏ 8443
   - TLS/SSL 1.2+

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ –≤—Ä—É—á–Ω—É—é

–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ API:

```typescript
const provider = new YooKassaProvider();
const status = await provider.getPaymentStatus('payment-id');
console.log(status); // { status: 1, paid: true }
```

### –ö–æ–¥—ã —Å—Ç–∞—Ç—É—Å–æ–≤

- `0` - pending (–æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
- `1` - succeeded (—É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω)
- `2` - waiting_for_capture (–æ–∂–∏–¥–∞–µ—Ç —Å–ø–∏—Å–∞–Ω–∏—è)
- `3` - canceled (–æ—Ç–º–µ–Ω–µ–Ω)

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ YooKassa
- ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è HTTPS
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (401)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ YOOKASSA_SHOP_ID –∏ YOOKASSA_SECRET_KEY
- ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –∫–ª—é—á–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ webhook endpoint
- ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ orderId –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ë–î

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ YooKassa

1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Üí –õ–æ–≥–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö webhook
2. **–ü–ª–∞—Ç–µ–∂–∏** - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π —Å –¥–µ—Ç–∞–ª—è–º–∏
3. **–†–µ–µ—Å—Ç—Ä—ã** - –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –æ –ø–ª–∞—Ç–µ–∂–∞—Ö

### –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

–í—Å–µ –ª–æ–≥–∏ –ø–ª–∞—Ç–µ–∂–µ–π –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `orders` –≤ Supabase:
- `payment_status` - —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã
- `payment_id` - ID –ø–ª–∞—Ç–µ–∂–∞ –≤ YooKassa
- `payment_provider` - –ø—Ä–æ–≤–∞–π–¥–µ—Ä (yookassa)

## üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏

–ß—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ 1plat:
```env
PAYMENT_PROVIDER=oneplat
```

–ß—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å YooKassa:
```env
PAYMENT_PROVIDER=yookassa
```

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ —Å ngrok
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
- [ ] –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ production
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å production webhook URL
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ –Ω–∞ production
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–ª–∞—Ç–µ–∂–µ–π
