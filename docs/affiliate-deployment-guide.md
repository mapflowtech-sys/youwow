# üì¶ –î–µ–ø–ª–æ–π –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã

## 1Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Supabase (–ë–î)

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –≤ **Supabase Dashboard**
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `supabase/migrations/001_create_affiliate_tables.sql`
4. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL-–∑–∞–ø—Ä–æ—Å (Execute SQL)
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã: **Table Editor** ‚Üí –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è:
   - `partners`
   - `partner_clicks`
   - `partner_conversions`
   - `partner_payouts`

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

–í SQL Editor –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```sql
INSERT INTO partners (id, name, website, commission_rate, notes) VALUES
  ('dnsshop', 'DNS Shop', 'https://dnsshop.ru', 200.00, '–ö—Ä—É–ø–Ω–∞—è —Å–µ—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏'),
  ('test-partner', '–¢–µ—Å—Ç–æ–≤—ã–π –ø–∞—Ä—Ç–Ω—ë—Ä', NULL, 10.00, '–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–¥–µ');
```

---

## 2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ (Vercel)

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Vercel Dashboard** ‚Üí –í–∞—à –ø—Ä–æ–µ–∫—Ç ‚Üí **Settings** ‚Üí **Environment Variables**

–î–æ–±–∞–≤—å—Ç–µ:

```bash
# Supabase (—É–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# URL —Å–∞–π—Ç–∞ –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
NEXT_PUBLIC_SITE_URL=https://youwow.ru
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç–µ:

–≠—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
- ‚úÖ `NEXT_PUBLIC_SUPABASE_URL`
- ‚úÖ `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- ‚úÖ `SUPABASE_SERVICE_ROLE_KEY`

–ï—Å–ª–∏ –∏—Ö –Ω–µ—Ç - –¥–æ–±–∞–≤—å—Ç–µ –∏–∑ Supabase Dashboard ‚Üí Project Settings ‚Üí API.

### –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –æ–ø–ª–∞—Ç–æ–π 10 —Ä—É–±–ª–µ–π:

–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤, –Ω–µ –Ω–∞ production!):

```
YOOKASSA_MIN_TEST_PRICE=1000
```

**–í–∞–∂–Ω–æ:**
- –£–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ **–ö–û–ü–ï–ô–ö–ê–•**: `1000` = 10‚ÇΩ, `59000` = 590‚ÇΩ
- –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è **–Ω–µ —É–∫–∞–∑–∞–Ω–∞** ‚Üí —Ü–µ–Ω–∞ –±—É–¥–µ—Ç 590‚ÇΩ (–∫–∞–∫ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ `YOOKASSA_MIN_TEST_PRICE=1000` ‚Üí —Ü–µ–Ω–∞ –±—É–¥–µ—Ç 10‚ÇΩ
- –ù–∞ production **–Ω–µ —Å—Ç–∞–≤—å—Ç–µ** —ç—Ç—É –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, —á—Ç–æ–±—ã —Ü–µ–Ω–∞ –±—ã–ª–∞ —Ä–µ–∞–ª—å–Ω–æ–π!

**–ü—Ä–∏–º–µ—Ä—ã:**
- 10‚ÇΩ: `YOOKASSA_MIN_TEST_PRICE=1000`
- 50‚ÇΩ: `YOOKASSA_MIN_TEST_PRICE=5000`
- 100‚ÇΩ: `YOOKASSA_MIN_TEST_PRICE=10000`

---

## 3Ô∏è‚É£ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ SQL Editor –≤ Supabase

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–º–∏—Å—Å–∏—é **10 —Ä—É–±–ª–µ–π** –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞ `test-partner`:

```sql
UPDATE partners
SET commission_rate = 10.00
WHERE id = 'test-partner';
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞

```sql
INSERT INTO partners (id, name, commission_rate, is_active)
VALUES ('new-partner', '–ù–æ–≤—ã–π –ø–∞—Ä—Ç–Ω—ë—Ä', 10.00, true);
```

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

- –ö–æ–º–∏—Å—Å–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `partners` –≤ –ø–æ–ª–µ `commission_rate`
- –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: **200‚ÇΩ**
- –ö–∞–∂–¥—ã–π –ø–∞—Ä—Ç–Ω—ë—Ä –º–æ–∂–µ—Ç –∏–º–µ—Ç—å **—Å–≤–æ—é –∫–æ–º–∏—Å—Å–∏—é**
- –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –±–µ—Ä—ë—Ç—Å—è –∫–æ–º–∏—Å—Å–∏—è –∏–∑ –ë–î –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞

**–ü—Ä–∏–º–µ—Ä:**
- –ü–∞—Ä—Ç–Ω—ë—Ä `dnsshop`: –∫–æ–º–∏—Å—Å–∏—è 200‚ÇΩ
- –ü–∞—Ä—Ç–Ω—ë—Ä `test-partner`: –∫–æ–º–∏—Å—Å–∏—è 10‚ÇΩ
- –ü–∞—Ä—Ç–Ω—ë—Ä `vip-partner`: –∫–æ–º–∏—Å—Å–∏—è 300‚ÇΩ

---

## 4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è

### –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç:** `https://youwow.ru/song?partner=test-partner`

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ cookie:**
   - DevTools ‚Üí Application ‚Üí Cookies
   - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å cookie `youwow_partner`

3. **–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑:**
   - –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É
   - –û–ø–ª–∞—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π
   - –î–æ–∂–¥–∏—Ç–µ—Å—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Supabase:**
   - Table Editor ‚Üí `partner_clicks` ‚Üí –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–ø–∏—Å—å
   - Table Editor ‚Üí `partner_conversions` ‚Üí –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–µ—Å–Ω–∏

5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Vercel:**
   - Vercel Dashboard ‚Üí Deployments ‚Üí Functions ‚Üí Logs
   - –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏: `[Affiliate] Conversion tracked successfully`

---

## 5Ô∏è‚É£ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤

### –ß–µ—Ä–µ–∑ SQL Editor:

```sql
INSERT INTO partners (id, name, website, payment_info, commission_rate, notes)
VALUES (
  'partnerId',           -- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID (–ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)
  '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞',   -- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è
  'https://site.ru',     -- –°–∞–π—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞
  '–ö–∞—Ä—Ç–∞ –°–±–µ—Ä–ë–∞–Ω–∫ 5536 9137 XXXX XXXX, –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤', -- –†–µ–∫–≤–∏–∑–∏—Ç—ã
  250.00,                -- –ö–æ–º–∏—Å—Å–∏—è –≤ —Ä—É–±–ª—è—Ö
  'VIP-–ø–∞—Ä—Ç–Ω—ë—Ä, –ø–æ–≤—ã—à–µ–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è' -- –ó–∞–º–µ—Ç–∫–∏
);
```

### –§–æ—Ä–º–∞—Ç –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π —Å—Å—ã–ª–∫–∏:

```
https://youwow.ru/song?partner=partnerId
https://youwow.ru/santa?partner=partnerId
https://youwow.ru/?partner=partnerId
```

---

## 6Ô∏è‚É£ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã:

```sql
-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–∫–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
SELECT partner_id, COUNT(*) as clicks
FROM partner_clicks
WHERE clicked_at >= CURRENT_DATE
GROUP BY partner_id;

-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω–≤–µ—Ä—Å–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è
SELECT partner_id, COUNT(*) as conversions, SUM(commission) as total_commission
FROM partner_conversions
WHERE converted_at >= CURRENT_DATE
GROUP BY partner_id;

-- –¢–æ–ø –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –ø–æ –∫–æ–Ω–≤–µ—Ä—Å–∏—è–º
SELECT p.name, COUNT(c.id) as conversions, SUM(c.commission) as earned
FROM partners p
LEFT JOIN partner_conversions c ON p.id = c.partner_id
WHERE c.converted_at >= CURRENT_DATE - INTERVAL '7 days'
GROUP BY p.name
ORDER BY conversions DESC;
```

---

## üî• –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

1. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –º–∏–≥—Ä–∞—Ü–∏—é** –≤ Supabase
2. **–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞** —Å ID `test-partner` –∏ –∫–æ–º–∏—Å—Å–∏–µ–π 10‚ÇΩ
3. **–ó–∞–¥–µ–ø–ª–æ–π—Ç–µ** –Ω–∞ Vercel (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ push –Ω–∞ GitHub)
4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ** —Å—Å—ã–ª–∫—É: `https://youwow.ru/song?partner=test-partner`
5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ** —Ç–∞–±–ª–∏—Ü—ã –≤ Supabase –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏

**–í—Å—ë –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!** üöÄ

---

## ‚ùì Troubleshooting

### –ö–æ–Ω–≤–µ—Ä—Å–∏–∏ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è?

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Vercel Functions
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `NEXT_PUBLIC_SITE_URL` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ `partners` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞ —Å –Ω—É–∂–Ω—ã–º ID
4. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–∞—Ä—Ç–Ω—ë—Ä –∞–∫—Ç–∏–≤–µ–Ω (`is_active = true`)

### Cookie –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è?

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ middleware —Ä–∞–±–æ—Ç–∞–µ—Ç (–ª–æ–≥–∏ –≤ Vercel)
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä `?partner=xxx` –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (—Ä–∞–∑—Ä–µ—à–µ–Ω—ã –ª–∏ cookie)

### –û—à–∏–±–∫–∞ "Partner not found"?

–ü–∞—Ä—Ç–Ω—ë—Ä —Å —Ç–∞–∫–∏–º ID –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ `partners`. –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ SQL Editor.
