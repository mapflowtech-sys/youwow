# Инструкция по тестированию партнёрской системы YouWow

## Введение

Эта инструкция описывает полный сценарий тестирования партнёрской системы от создания партнёра до выплаты комиссии.

---

## Подготовка к тестированию

### 1. Доступ к инструментам

Вам понадобится:
- Доступ к админ-панели: `https://youwow.ru/admin/partners`
- Доступ к Supabase Dashboard: `https://supabase.com/dashboard`
- Браузер с DevTools (Chrome/Firefox)
- Режим инкогнито для чистого тестирования

### 2. Проверка базы данных

1. Откройте Supabase Dashboard
2. Перейдите в Table Editor
3. Убедитесь, что существуют таблицы:
   - `partners`
   - `partner_clicks`
   - `partner_conversions`
   - `partner_payouts`

---

## Сценарий 1: Создание партнёра

### Шаги:

1. Откройте админ-панель: `https://youwow.ru/admin/partners`
2. Нажмите **"Создать партнёра"**
3. Заполните форму:
   ```
   ID: test-partner1
   Название: Тестовый партнёр 1
   Сайт: https://example.com
   Реквизиты: 1234 5678 9012 3456
   Комиссия: 200
   Статус: Активен
   Заметки: Тестовый партнёр для проверки системы
   ```
4. Нажмите **"Создать"**

### Проверка:

- ✅ Партнёр появился в списке
- ✅ Отображается корректная информация
- ✅ В Supabase появилась запись в таблице `partners`

**Проверка в Supabase:**
```sql
SELECT * FROM partners WHERE id = 'test-partner1';
```

---

## Сценарий 2: Отслеживание клика

### Шаги:

1. Скопируйте партнёрскую ссылку:
   ```
   https://youwow.ru/song?partner=test-partner1
   ```

2. Откройте **новое окно в режиме инкогнито**

3. Вставьте ссылку в адресную строку и перейдите

4. Откройте DevTools (F12) → вкладка **Application** → **Cookies** → `youwow.ru`

5. Найдите cookie с именем `partner_data`

### Проверка:

- ✅ Cookie `partner_data` создалась
- ✅ В cookie есть данные: `partnerId`, `sessionId`, `clickedAt`, `landingPage`
- ✅ В Supabase появилась запись в таблице `partner_clicks`

**Проверка в Supabase:**
```sql
SELECT * FROM partner_clicks WHERE partner_id = 'test-partner1' ORDER BY clicked_at DESC LIMIT 1;
```

**Ожидаемый результат:**
| id | partner_id | session_id | clicked_at | landing_page |
|----|------------|------------|------------|--------------|
| ... | test-partner1 | UUID | timestamp | /song |

**Если клик не отследился:**
- Проверьте, что middleware работает (посмотрите логи в Vercel)
- Проверьте, что cookies включены в браузере
- Проверьте, что используете именно `?partner=test-partner1`

---

## Сценарий 3: Конверсия (покупка)

### Шаги:

1. В том же окне инкогнито (где создавалась cookie):
   - Заполните форму создания песни
   - Нажмите "Создать песню"
   - Дождитесь перехода на страницу оплаты

2. Оплатите заказ (используйте тестовую карту или реальную)

3. Дождитесь генерации песни

### Проверка:

- ✅ В Supabase появилась запись в таблице `partner_conversions`
- ✅ Запись связана с партнёром `test-partner1`
- ✅ Поле `is_paid_out = false`

**Проверка в Supabase:**
```sql
SELECT * FROM partner_conversions WHERE partner_id = 'test-partner1' ORDER BY converted_at DESC LIMIT 1;
```

**Ожидаемый результат:**
| id | partner_id | session_id | order_id | service_type | amount | commission | is_paid_out | converted_at |
|----|------------|------------|----------|--------------|--------|------------|-------------|--------------|
| ... | test-partner1 | UUID | UUID | song | 999.00 | 200.00 | false | timestamp |

**Проверка связи клика и конверсии:**
```sql
SELECT
  pc.partner_id,
  pc.session_id,
  pc.clicked_at,
  conv.converted_at,
  conv.commission
FROM partner_clicks pc
LEFT JOIN partner_conversions conv ON pc.session_id = conv.session_id
WHERE pc.partner_id = 'test-partner1'
ORDER BY pc.clicked_at DESC;
```

**Если конверсия не отследилась:**
- Проверьте, что cookie `partner_data` была на странице оплаты
- Проверьте логи создания заказа (файл: `app/api/song/route.ts` или где создаётся order)
- Убедитесь, что функция `trackPartnerConversion` вызывается после оплаты

---

## Сценарий 4: Проверка статистики в админ-панели

### Шаги:

1. Обновите страницу админ-панели
2. Кликните на партнёра `test-partner1`
3. Изучите статистику

### Проверка:

- ✅ **Переходы:** >= 1
- ✅ **Покупки:** >= 1
- ✅ **Конверсия:** рассчитана корректно (например, 1 покупка / 1 переход = 100%)
- ✅ **Заработано:** сумма комиссии (например, 200₽)
- ✅ **К выплате:** сумма комиссии (например, 200₽)
- ✅ **Выплачено:** 0₽
- ✅ График показывает 1 переход и 1 покупку за сегодня
- ✅ В таблице конверсий есть запись со статусом "Ожидает"

**Если статистика показывает нули:**
- Проверьте, что клик и конверсия действительно есть в Supabase
- Проверьте, что `partner_id` совпадает во всех таблицах
- Обновите страницу (иногда нужно время на обновление)
- Проверьте консоль браузера на наличие ошибок API

---

## Сценарий 5: Редактирование партнёра

### Шаги:

1. На странице партнёра в разделе **"Настройки"** нажмите **"Редактировать"**
2. Измените:
   ```
   Комиссия: 250 (было 200)
   Сайт: https://new-site.com
   Реквизиты: 9999 8888 7777 6666
   Заметки: Обновлённая информация
   ```
3. Нажмите **"Сохранить"**

### Проверка:

- ✅ Данные обновились на странице
- ✅ В Supabase запись обновилась

**Проверка в Supabase:**
```sql
SELECT commission_rate, website, payment_info, notes FROM partners WHERE id = 'test-partner1';
```

**Ожидаемый результат:**
```
commission_rate: 250.00
website: https://new-site.com
payment_info: 9999 8888 7777 6666
notes: Обновлённая информация
```

---

## Сценарий 6: Выплата комиссии

### Шаги:

1. На странице партнёра нажмите **"Отметить выплату"** (кнопка появляется, если "К выплате" > 0)
2. Проверьте автоматически заполненные поля:
   - Период: с начала месяца до сегодня
   - Сумма: рассчитана автоматически
3. Заполните:
   ```
   Способ оплаты: СБП
   Заметки: Первая тестовая выплата
   ```
4. Нажмите **"Подтвердить выплату"**

### Проверка:

- ✅ Модальное окно закрылось
- ✅ "К выплате" стало 0₽
- ✅ "Выплачено" увеличилось на сумму комиссии
- ✅ В таблице конверсий статус изменился на "Выплачено" (зелёная метка)
- ✅ Кнопка "Отметить выплату" исчезла

**Проверка в Supabase:**

1. Таблица `partner_conversions`:
   ```sql
   SELECT id, commission, is_paid_out FROM partner_conversions WHERE partner_id = 'test-partner1';
   ```
   **Ожидаемый результат:** `is_paid_out = true`

2. Таблица `partner_payouts`:
   ```sql
   SELECT * FROM partner_payouts WHERE partner_id = 'test-partner1' ORDER BY paid_at DESC LIMIT 1;
   ```
   **Ожидаемый результат:**
   | id | partner_id | amount | conversions_count | period_start | period_end | payment_method | notes |
   |----|------------|--------|-------------------|--------------|------------|----------------|-------|
   | ... | test-partner1 | 200.00 | 1 | timestamp | timestamp | СБП | Первая тестовая выплата |

---

## Сценарий 7: Управление статусом партнёра

### Тест 1: Деактивация

**Шаги:**
1. На странице партнёра нажмите **"Деактивировать"**
2. Подтвердите действие

**Проверка:**
- ✅ Статус изменился на "Неактивен" (жёлтая метка)
- ✅ Кнопка изменилась на "Активировать"

**Проверка в Supabase:**
```sql
SELECT status FROM partners WHERE id = 'test-partner1';
```
**Ожидаемый результат:** `status = 'inactive'`

**Тест партнёрской ссылки:**
- Откройте новое окно инкогнито
- Перейдите по ссылке `https://youwow.ru/song?partner=test-partner1`
- **Ожидаемый результат:** Клик НЕ должен отслеживаться (проверьте в Supabase)

### Тест 2: Активация

**Шаги:**
1. Нажмите **"Активировать"**
2. Подтвердите действие

**Проверка:**
- ✅ Статус изменился на "Активен" (зелёная метка)
- ✅ Кнопка изменилась на "Деактивировать"

**Проверка в Supabase:**
```sql
SELECT status FROM partners WHERE id = 'test-partner1';
```
**Ожидаемый результат:** `status = 'active'`

### Тест 3: Архивация

**Шаги:**
1. Нажмите **"В архив"**
2. Подтвердите действие

**Проверка:**
- ✅ Статус изменился на "В архиве" (серая метка)
- ✅ Кнопка изменилась на "Восстановить"
- ✅ Партнёр исчез из списка "Активные"
- ✅ Партнёр появился в списке "Архив"

**Проверка в Supabase:**
```sql
SELECT status, archived_at FROM partners WHERE id = 'test-partner1';
```
**Ожидаемый результат:** `status = 'archived'`, `archived_at` не NULL

**Тест партнёрской ссылки:**
- Откройте новое окно инкогнито
- Перейдите по ссылке `https://youwow.ru/song?partner=test-partner1`
- **Ожидаемый результат:** Клик ДОЛЖЕН отслеживаться (архивные партнёры продолжают работать)

### Тест 4: Восстановление из архива

**Шаги:**
1. Перейдите во вкладку **"Архив"**
2. Кликните на партнёра `test-partner1`
3. Нажмите **"Восстановить"**
4. Подтвердите действие

**Проверка:**
- ✅ Партнёр исчез из списка "Архив"
- ✅ Партнёр появился в списке "Активные"
- ✅ Статус изменился на "Активен"

---

## Сценарий 8: Проверка графиков

### Шаги:

1. На странице партнёра изучите график "Статистика по дням"
2. Переключите период: 7 дней, 30 дней, 90 дней

### Проверка:

- ✅ График отображается корректно
- ✅ Видны линии "Переходы" (фиолетовая) и "Покупки" (зелёная)
- ✅ За сегодня отображается 1 переход и 1 покупка
- ✅ При изменении периода график обновляется
- ✅ Tooltip показывает корректные данные при наведении

**Если график пустой:**
- Проверьте консоль браузера на ошибки
- Проверьте API: `GET /api/partners/test-partner1/chart-data?days=30`
- Убедитесь, что в Supabase есть данные в `partner_clicks` и `partner_conversions`

---

## Сценарий 9: Множественные конверсии

### Шаги:

1. Повторите Сценарий 2 и 3 ещё 2-3 раза:
   - Откройте новое окно инкогнито
   - Перейдите по партнёрской ссылке
   - Создайте песню и оплатите

2. Проверьте статистику

### Проверка:

- ✅ **Переходы:** увеличились (например, 4)
- ✅ **Покупки:** увеличились (например, 4)
- ✅ **К выплате:** сумма всех невыплаченных комиссий
- ✅ Таблица конверсий показывает все покупки
- ✅ График показывает увеличение

---

## Сценарий 10: Публичный дашборд партнёра

### Шаги:

1. Откройте личный кабинет партнёра:
   ```
   https://youwow.ru/partners/test-partner1
   ```

2. Изучите страницу

### Проверка:

- ✅ Отображается название партнёра
- ✅ KPI карточки показывают корректные данные
- ✅ График работает
- ✅ Партнёрская ссылка отображается
- ✅ Можно скопировать ссылку (кнопка копирования работает)

**Если страница показывает "Партнёр не найден":**
- Проверьте, что партнёр существует в Supabase
- Проверьте, что используете правильный ID
- Проверьте API: `GET /api/partners/test-partner1/stats`

---

## Сценарий 11: Тестирование с несколькими партнёрами

### Шаги:

1. Создайте второго партнёра:
   ```
   ID: test-partner2
   Название: Тестовый партнёр 2
   Комиссия: 300
   ```

2. Повторите Сценарии 2-3 для `test-partner2`

### Проверка:

- ✅ Оба партнёра отображаются в списке
- ✅ Статистика не пересекается (у каждого свои клики/конверсии)
- ✅ Можно переключаться между партнёрами

---

## Проверка edge cases (граничные случаи)

### 1. Клик без покупки

**Шаги:**
1. Откройте партнёрскую ссылку в инкогнито
2. НЕ покупайте песню, просто закройте окно

**Проверка:**
- ✅ Клик отследился в `partner_clicks`
- ✅ Конверсия НЕ создалась
- ✅ Конверсия партнёра = 0% (или меньше 100%)

### 2. Покупка без партнёрской ссылки

**Шаги:**
1. Откройте сайт напрямую (без `?partner=`)
2. Создайте песню и оплатите

**Проверка:**
- ✅ Заказ создался
- ✅ Конверсия НЕ привязалась к партнёру
- ✅ В `partner_conversions` новой записи нет

### 3. Старая cookie (> 30 дней)

**Тест невозможен без изменения даты**, но логика:
- Cookie истекает через 30 дней
- Если пользователь кликнул 31 день назад и покупает сегодня → конверсия НЕ засчитается

### 4. Выплата при отсутствии конверсий

**Шаги:**
1. Создайте партнёра без конверсий
2. Попробуйте сделать выплату

**Проверка:**
- ✅ Кнопка "Отметить выплату" НЕ отображается (т.к. "К выплате" = 0)

### 5. Частичная выплата

**Шаги:**
1. Создайте 3 конверсии с разными датами (например, 1 января, 15 января, 30 января)
2. Сделайте выплату только за период 1-15 января

**Проверка:**
- ✅ Выплачены только конверсии за период
- ✅ Конверсия от 30 января осталась невыплаченной
- ✅ "К выплате" показывает сумму невыплаченной конверсии

---

## Чеклист перед запуском в продакшн

- [ ] Все сценарии (1-11) пройдены успешно
- [ ] Проверена работа с разных устройств (десктоп, мобильный)
- [ ] Проверена работа в разных браузерах (Chrome, Safari, Firefox)
- [ ] Middleware корректно обрабатывает партнёрские ссылки
- [ ] Статистика обновляется в реальном времени
- [ ] Графики отображаются корректно
- [ ] Выплаты работают правильно
- [ ] Публичный дашборд доступен партнёрам
- [ ] База данных имеет бэкапы
- [ ] Нет ошибок в консоли браузера
- [ ] Нет ошибок в логах Vercel

---

## Что делать при обнаружении багов

1. **Запишите все детали:**
   - Что делали (точные шаги)
   - Что ожидали увидеть
   - Что увидели на самом деле
   - Скриншоты/видео (если возможно)

2. **Проверьте консоль:**
   - Откройте DevTools (F12) → Console
   - Скопируйте все ошибки

3. **Проверьте API:**
   - Откройте DevTools (F12) → Network
   - Найдите неудачный запрос (красный)
   - Посмотрите Response

4. **Проверьте Supabase:**
   - Есть ли данные в таблицах?
   - Корректны ли связи между таблицами?

5. **Сообщите Claude Code:**
   - Опишите проблему подробно
   - Приложите ошибки из консоли
   - Укажите, на каком шаге произошла проблема

---

**Удачного тестирования!**
