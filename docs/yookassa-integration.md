# Интеграция Яндекс Юкасса

## Основная информация

- **API Endpoint**: `https://api.yookassa.ru/v3/`
- **Протокол**: HTTP/REST
- **Формат данных**: JSON
- **Shop ID**: `1229933`
- **Секретный ключ**: `live_4mvUbA8fN9DWepS5Z_3qPAfNX1q6osihl6LYqbvTYy8`

## Аутентификация

### HTTP Basic Auth

Для аутентификации используется HTTP Basic Auth:
- **Username**: Идентификатор магазина (shopId)
- **Password**: Секретный ключ

Пример заголовка:
```
Authorization: Basic <base64(shopId:secretKey)>
```

Пример cURL запроса:
```bash
curl https://api.yookassa.ru/v3/payments/{payment_id} \
  -u <Идентификатор магазина>:<Секретный ключ>
```

## Типы запросов

- **POST**: Используют JSON-аргументы
- **GET**: Работают со строками запросов
- **DELETE**: Работают со строками запросов
- Все ответы возвращаются в формате JSON

## Безопасность

⚠️ **Важно**: Секретный ключ должен храниться только на сервере (в переменных окружения), никогда не передавайте его на клиент!

## Для приема платежей

- **Идентификатор магазина**: Находится в разделе Настройки → Магазин (поле shopId)
- **Секретный ключ**: Раздел Интеграция → Ключи API

## Идемпотентность

Для обеспечения идемпотентности используется заголовок `Idempotence-Key`:
- Длина: до 64 символов
- Рекомендуется: V4 UUID
- Обеспечивается в течение 24 часов

```bash
curl https://api.yookassa.ru/v3/payments \
  -X POST \
  -u <shopId>:<secretKey> \
  -H 'Idempotence-Key: <UUID>' \
  -H 'Content-Type: application/json' \
  -d '{ ... }'
```

## Коды ответа HTTP

| Код | Описание |
|-----|----------|
| 200 | Успешно обработан |
| 400 | Неправильный запрос (invalid_request) |
| 401 | Неверная аутентификация (invalid_credentials) |
| 403 | Недостаточно прав (forbidden) |
| 404 | Ресурс не найден (not_found) |
| 429 | Превышен лимит запросов (too_many_requests) |
| 500 | Технические неполадки (internal_server_error) |

⚠️ **HTTP 500**: Результат неизвестен - необходимо проверить статус платежа отдельным запросом!

## Статусы платежа

- `pending` - ожидает подтверждения от пользователя
- `waiting_for_capture` - оплачен, ожидает списания (двухстадийный платеж)
- `succeeded` - успешно завершен (финальный)
- `canceled` - отменен (финальный)

## Входящие уведомления (Webhooks)

### Настройка
В личном кабинете: **Интеграция → HTTP-уведомления**
- URL должен использовать HTTPS (порт 443 или 8443)
- TLS/SSL 1.2+

### Доступные события
- `payment.waiting_for_capture` - платеж ожидает списания
- `payment.succeeded` - платеж успешен
- `payment.canceled` - платеж отменен
- `refund.succeeded` - возврат выполнен

## Быстрый старт - Создание платежа

### Шаг 1: Создать платеж

```bash
curl https://api.yookassa.ru/v3/payments \
  -X POST \
  -u 1229933:live_4mvUbA8fN9DWepS5Z_3qPAfNX1q6osihl6LYqbvTYy8 \
  -H 'Idempotence-Key: <UUID>' \
  -H 'Content-Type: application/json' \
  -d '{
        "amount": {
          "value": "100.00",
          "currency": "RUB"
        },
        "capture": true,
        "confirmation": {
          "type": "redirect",
          "return_url": "https://yoursite.com/return"
        },
        "description": "Заказ №1"
      }'
```

### Шаг 2: Перенаправить на confirmation_url

Ответ содержит:
```json
{
  "id": "платеж-id",
  "status": "pending",
  "confirmation": {
    "type": "redirect",
    "confirmation_url": "https://yoomoney.ru/..."
  }
}
```

### Шаг 3: Дождаться успешного завершения

- Подписаться на webhook `payment.succeeded`
- Или периодически проверять статус GET `/v3/payments/{id}`

## Двухстадийные платежи

**Холдирование** (`capture: false`):
1. Деньги замораживаются (статус `waiting_for_capture`)
2. Списание по запросу (POST `/v3/payments/{id}/capture`)
3. Или отмена (POST `/v3/payments/{id}/cancel`)

**Сроки холдирования**: от 2 часов до 7 дней (зависит от способа оплаты)

### Полное списание
```bash
curl https://api.yookassa.ru/v3/payments/{payment_id}/capture \
  -X POST \
  -u 1229933:live_4mvUbA8fN9DWepS5Z_3qPAfNX1q6osihl6LYqbvTYy8 \
  -H 'Idempotence-Key: <UUID>' \
  -H 'Content-Type: application/json'
```

### Частичное списание
```bash
curl https://api.yookassa.ru/v3/payments/{payment_id}/capture \
  -X POST \
  -u 1229933:live_4mvUbA8fN9DWepS5Z_3qPAfNX1q6osihl6LYqbvTYy8 \
  -H 'Idempotence-Key: <UUID>' \
  -H 'Content-Type: application/json' \
  -d '{
        "amount": {
          "value": "50.00",
          "currency": "RUB"
        }
      }'
```

## Способы оплаты

### Банковская карта (bank_card)
- **Холдирование**: 7 дней
- **Возврат**: да (полный и частичный)
- **Автоплатежи**: да
- **Лимиты**: 1 - 350,000 руб

### СБП (sbp)
- **Холдирование**: нет
- **Возврат**: да (полный и частичный)
- **Автоплатежи**: да (с особенностями)
- **Лимиты**: 1 - 700,000 руб

### SberPay (sberbank)
- **Холдирование**: 7 дней
- **Возврат**: да
- **Автоплатежи**: да

### ЮMoney (yoo_money)
- **Холдирование**: 7 дней
- **Возврат**: да
- **Автоплатежи**: да

## Сценарии интеграции

### 1. Умный платеж (рекомендуется для старта)
Пользователь выбирает способ оплаты на странице ЮKassa

### 2. Виджет ЮKassa
Платежная форма встраивается на ваш сайт

### 3. Самостоятельная интеграция
Полный контроль над UI и процессом оплаты

---

## Умный платеж (подробная инструкция)

**Самый простой способ интеграции с ЮKassa.** Вам нужно только перенаправить пользователя на страницу ЮKassa, где он выберет подходящий способ, введет данные для оплаты и ее подтвердит. Чтобы принять оплату по этому сценарию, необходимо создать платеж и реализовать сценарий подтверждения Redirect.

### Особенности

- Умный платеж поддерживает **все способы оплаты**, кроме:
  - Оплаты через СберБанк Бизнес Онлайн
  - Оплаты по электронному сертификату

- На платежной форме отображаются те способы, которые **подключены в вашем магазине**

- Если проводите платежи **в две стадии** или **сохраняете способ оплаты** для автоплатежей, на платежной форме отображаются только те способы, которые поддерживают используемую вами опцию

- **Пример**: если вы подключили СБП и проводите платеж в две стадии, то этот способ не отобразится на платежной форме, потому что не поддерживает эту опцию. Если это единственный способ оплаты, который есть в вашем магазине, то вы получите ошибку.

- **Mir Pay** будет доступен только для мобильных устройств на Android

- Если оплата не проходит, платежная форма **обрабатывает неуспешные попытки**: она отображает пользователю сообщение об ошибке и предлагает попробовать оплатить еще раз с повторным выбором способа оплаты. Доступно при оплате:
  - Произвольной банковской картой
  - Через Mir Pay
  - SberPay
  - T-Pay
  - СБП
  - Сервис «Плати частями»
  - Из кошелька ЮMoney

  Вы можете отключить эту настройку через менеджера ЮKassa и обрабатывать неуспешные попытки самостоятельно.

### Проведение платежа

#### Шаг 1. Создайте платеж

Передайте в запросе объект `confirmation` с типом `redirect` и адресом страницы, на которую вернется пользователь после оплаты. Этот адрес должен быть **абсолютным** — с указанием протокола и домена сайта.

**Пример**: `https://example.com/return_url`

**Важно**: Данные о способе оплаты (`payment_method_data`, `payment_token`, `payment_method_id`) в запросе передавать **не нужно**.

```bash
curl https://api.yookassa.ru/v3/payments \
  -X POST \
  -u <Идентификатор магазина>:<Секретный ключ> \
  -H 'Idempotence-Key: <Ключ идемпотентности>' \
  -H 'Content-Type: application/json' \
  -d '{
        "amount": {
          "value": "100.00",
          "currency": "RUB"
        },
        "capture": true,
        "confirmation": {
          "type": "redirect",
          "return_url": "https://www.example.com/return_url"
        },
        "description": "Заказ №1"
      }'
```

#### Шаг 2. Перенаправьте пользователя

Перенаправьте пользователя на `confirmation_url`, который придет в объекте платежа. Это ссылка на страницу ЮKassa, на которой пользователь выберет нужный способ и введет данные для оплаты.

**Пример созданного объекта платежа:**

```json
{
  "id": "23d93cac-000f-5000-8000-126628f15141",
  "status": "pending",
  "paid": false,
  "amount": {
    "value": "100.00",
    "currency": "RUB"
  },
  "confirmation": {
    "type": "redirect",
    "confirmation_url": "https://yoomoney.ru/api-pages/v2/payment-confirm/epl?orderId=23d93cac-000f-5000-8000-126628f15141"
  },
  "created_at": "2019-01-22T14:30:45.129Z",
  "description": "Заказ №1",
  "metadata": {},
  "recipient": {
    "account_id": "100500",
    "gateway_id": "100700"
  },
  "refundable": false,
  "test": false
}
```

#### Шаг 3. Дождитесь успешного завершения платежа

Два способа:
1. Подождите, когда придет **уведомление от ЮKassa** (webhook)
2. Периодически отправляйте запросы, чтобы **получить информацию о платеже** (GET `/v3/payments/{id}`)

## Дополнительная документация (не включена)

Доступны отдельные инструкции по:
- Отдельным способам оплаты (SberPay, ЮMoney, Mir Pay, и т.д.)
- Отправке чеков в налоговую (54-ФЗ)
- Возвратам
- Реестрам
- Тестированию

**Полная спецификация**: `yookassa-openapi.yaml`

---

## Тестирование платежей

### О тестовом режиме

Тестовый режим доступен сразу после регистрации в личном кабинете ЮKassa — вы можете протестировать платежи в любой момент, **даже до указания данных компании и заключения договора**.

**Особенности тестового режима:**
- Всё проходит как при настоящих платежах, но **деньги никуда не переводятся**
- Для аутентификации используйте идентификатор и секретный ключ **тестового магазина**
- В объектах платежей параметр `test` принимает значение `true`
- Доступны все основные возможности API

**Пример тестового платежа:**
```json
{
  "id": "23d93cac-000f-5000-8000-126628f15141",
  "status": "pending",
  "test": true,
  ...
}
```

### Что можно протестировать

Доступны все возможности API для следующих способов оплаты:
- ✅ Оплата банковской картой (на странице ЮKassa, с токеном, на вашей странице с PCI DSS)
- ✅ Оплата из кошелька ЮMoney
- ✅ Автоплатежи
- ✅ Отправка данных для чеков по 54-ФЗ (стороння онлайн-касса)

### Тестовый магазин

#### Создание тестового магазина

**Вариант 1: Еще не зарегистрированы в ЮKassa**
1. Зарегистрируйтесь по ссылке: https://yookassa.ru/
2. Выберите "Перейти к тестированию платежей"
3. Получите созданный тестовый магазин

**Вариант 2: У вас есть личный кабинет**
1. Добавьте тестовый магазин в личном кабинете
2. Настройте нужные параметры
3. Магазин появится в списке в течение минуты

⚠️ Максимум 20 тестовых магазинов

### Тестирование интеграции

#### Шаг 1: Получите учетные данные тестового магазина

В личном кабинете получите:
- **Shop ID** тестового магазина
- **Секретный ключ** тестового магазина

#### Шаг 2: Настройте тестовый магазин

1. **Уведомления**: Интеграция → HTTP-уведомления
   - ⚠️ Используйте специальный тестовый URL (не production!)

2. **Онлайн-Касса** (если используете 54-ФЗ):
   - Настройки → Онлайн-Касса
   - Включите режим проверки чеков

3. **ЖКУ** (если принимаете платежи за ЖКХ):
   - Настройки → Магазин → Настройка платежей
   - Включите соответствующую опцию

#### Шаг 3: Тестовые банковские карты

⚠️ **Настоящие карты нельзя использовать в тестовом магазине!**

**Успешные сценарии:**

| Номер карты | Тип | 3-D Secure |
|-------------|-----|------------|
| `5555555555554477` | Mastercard | ✔️ |
| `5555555555554444` | Mastercard | ❌ |
| `4793128161644804` | Visa | ✔️ |
| `4111111111111111` | Visa | ❌ |
| `2200000000000004` | Mir | ✔️ |
| `2202474301322987` | Mir | ❌ |

**Для любой карты:**
- **Срок действия**: любая дата из будущего (например, `12/25`)
- **CVC**: любые 3 цифры (например, `123`)
- **3-D Secure код**: любые числа

⚠️ **Для автоплатежей**: Используйте карты **без 3-D Secure** (иначе повторный платеж не пройдет)

**Неуспешные сценарии (проверка ошибок):**

| Номер карты | Причина отмены |
|-------------|----------------|
| `5555555555554592` (Mastercard) | `3d_secure_failed` |
| `5555555555554543` (Mastercard) | `card_expired` |
| `5555555555554600` (Mastercard) | `insufficient_funds` |
| `5555555555554618` (Mastercard) | `invalid_card_number` |
| `5555555555554626` (Mastercard) | `invalid_csc` |

### Оплата из кошелька ЮMoney

Для тестирования **тестовый кошелек не нужен**:
1. Выберите способ оплаты "ЮMoney"
2. Нажмите "Заплатить"
3. Платеж завершится успешно автоматически

### Тестирование автоплатежей

**Успешный сценарий:**
- Для банковских карт: используйте карты **без 3-D Secure** (например, `5555555555554444`)
- Для ЮMoney: тестовый кошелек не нужен, платеж пройдет автоматически

**Неуспешный сценарий при повторном платеже:**

Используйте эти карты для сохранения способа оплаты. При повторном платеже получите ошибку `insufficient_funds`:
- `5555555555554642` (Mastercard)
- `4000000000000002` (Visa)
- `2200000000000079` (Mir)

### Важные замечания

⚠️ **НЕ отдавайте товар**, за который заплатили через тестовый магазин!

⚠️ Для тестовых уведомлений используйте **специальный URL** (не production webhook URL)

✅ Перед запуском на production проверьте, что используете **настоящий магазин** с правильными учетными данными

---

## Следующие шаги

1. ✅ Данные получены (shopId, секретный ключ)
2. ✅ Настроить переменные окружения
3. ✅ Создать API endpoints для платежей
4. ⏳ Настроить webhooks
5. ⏳ Протестировать в тестовом режиме с тестовыми картами
