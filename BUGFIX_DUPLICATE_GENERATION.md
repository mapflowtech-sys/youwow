# –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–µ—Å–µ–Ω

## üö® –ü—Ä–æ–±–ª–µ–º–∞

**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø
**–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —É—â–µ—Ä–±:** 2x —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–∞–∂–¥–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
**–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:** 30.12.2025, 03:15

### –°–∏–º–ø—Ç–æ–º—ã:
1. –ü—Ä–∏ –∫–∞–∂–¥–æ–π –æ–ø–ª–∞—Ç–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å **2 –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–µ—Å–Ω–∏** –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–π
2. –í Gen-API —Å–æ–∑–¥–∞–≤–∞–ª–æ—Å—å **2 –∑–∞–ø—Ä–æ—Å–∞ –∫ ChatGPT** (–¥—É–±–ª–∏ —Ç–µ–∫—Å—Ç–æ–≤)
3. –í Suno –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å **2 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º—É–∑—ã–∫–∏**
4. **–î–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ** –∫—Ä–µ–¥–∏—Ç–æ–≤ —Å –∞–∫–∫–∞—É–Ω—Ç–∞

### –ü—Ä–∏–º–µ—Ä –∏–∑ –ª–æ–≥–æ–≤:
```
Order: 990979ec-2ab9-45e9-b321-4880e23da3cc
- ChatGPT –≤—ã–∑–≤–∞–Ω 2 —Ä–∞–∑–∞ (–æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ç–µ–∫—Å—Ç)
- Suno –∑–∞–ø—É—â–µ–Ω 2 —Ä–∞–∑–∞ (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
- –ò—Ç–æ–≥: 2x —Ä–∞—Å—Ö–æ–¥ –Ω–∞ GenAPI
```

## üîç –ü—Ä–∏—á–∏–Ω–∞

**Race Condition** –º–µ–∂–¥—É –¥–≤—É–º—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –≤—ã–∑–æ–≤–∞ `/api/song/process`:

1. **–í–∏–¥–∂–µ—Ç YooKassa** (`PaymentWidget.tsx:95`) –≤—ã–∑—ã–≤–∞–µ—Ç `/api/song/process` –ø—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ `success`
2. **Webhook YooKassa** (`/api/payment/yookassa/webhook:65`) —Ç–æ–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç `/api/song/process` –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

### –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ –ø—Ä–æ–±–ª–µ–º—ã:

```
t=0ms:  –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞ –≤ YooKassa
t=10ms: –í–∏–¥–∂–µ—Ç –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ 'success'
t=12ms: –í–∏–¥–∂–µ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç /api/song/process
t=15ms: API –º–µ–Ω—è–µ—Ç status: pending -> paid
t=18ms: API –∑–∞–ø—É—Å–∫–∞–µ—Ç processSongGeneration() #1 ‚ö†Ô∏è
t=20ms: Webhook –æ—Ç YooKassa –ø—Ä–∏—Ö–æ–¥–∏—Ç
t=22ms: Webhook –≤—ã–∑—ã–≤–∞–µ—Ç /api/song/process
t=25ms: API –≤–∏–¥–∏—Ç status=paid (–ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É!)
t=28ms: API –∑–∞–ø—É—Å–∫–∞–µ—Ç processSongGeneration() #2 ‚ö†Ô∏è‚ö†Ô∏è
t=100ms: processSongGeneration #1 –º–µ–Ω—è–µ—Ç status –Ω–∞ processing
t=102ms: processSongGeneration #2 —Ç–æ–∂–µ –º–µ–Ω—è–µ—Ç status –Ω–∞ processing
```

### –û–∫–Ω–æ —É—è–∑–≤–∏–º–æ—Å—Ç–∏:
–ú–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏:
- `await updateOrderStatus(orderId, 'paid')` (—Å—Ç–∞—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ 42)
- `await updateOrderStatus(orderId, 'processing')` (—Å—Ç–∞—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ 76)

–ë—ã–ª–æ **–æ–∫–Ω–æ –≤ ~80-100ms**, –≤ –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–ø–∞–¥–∞–ª –≤—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å!

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `app/api/song/process/route.ts`:

**–ë—ã–ª–æ:**
```typescript
if (order.status !== 'pending' && order.status !== 'paid') {
  return NextResponse.json({ error: '–ó–∞–∫–∞–∑ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω' }, { status: 400 });
}

await updateOrderStatus(orderId, 'paid'); // ‚ö†Ô∏è –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å!

processSongGeneration(orderId, order.input_data)
  .catch(error => { ... });

// –í–Ω—É—Ç—Ä–∏ processSongGeneration:
await updateOrderStatus(orderId, 'processing'); // ‚ö†Ô∏è –û–∫–Ω–æ!
```

**–°—Ç–∞–ª–æ:**
```typescript
if (order.status !== 'pending' && order.status !== 'paid') {
  console.log(`[${orderId}] –ó–∞–∫–∞–∑ —É–∂–µ –≤ —Å—Ç–∞—Ç—É—Å–µ ${order.status}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
  return NextResponse.json({ error: '–ó–∞–∫–∞–∑ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω' }, { status: 400 });
}

// ‚úÖ –ê–¢–û–ú–ê–†–ù–û –º–µ–Ω—è–µ–º –Ω–∞ processing!
await updateOrderStatus(orderId, 'processing');
console.log(`[${orderId}] –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ processing, –∑–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é`);

processSongGeneration(orderId, order.input_data)
  .catch(error => { ... });

// –í–Ω—É—Ç—Ä–∏ processSongGeneration:
// –°—Ç–∞—Ç—É—Å –£–ñ–ï processing - –¥—É–±–ª—å –Ω–µ –ø—Ä–æ–π–¥—ë—Ç –ø—Ä–æ–≤–µ—Ä–∫—É!
```

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. ‚úÖ **–£–±—Ä–∞–ª–∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å `paid`** –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
2. ‚úÖ **–ê—Ç–æ–º–∞—Ä–Ω–æ –º–µ–Ω—è–µ–º** `pending` ‚Üí `processing` **–î–û** –∑–∞–ø—É—Å–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
3. ‚úÖ **–£–±—Ä–∞–ª–∏ –¥—É–±–ª–∏—Ä—É—é—â—É—é** —Å–º–µ–Ω—É —Å—Ç–∞—Ç—É—Å–∞ –≤–Ω—É—Ç—Ä–∏ `processSongGeneration()`
4. ‚úÖ **–î–æ–±–∞–≤–∏–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## üõ°Ô∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å:

```
t=0ms:  –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞ –≤ YooKassa
t=10ms: –í–∏–¥–∂–µ—Ç –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ 'success'
t=12ms: –í–∏–¥–∂–µ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç /api/song/process
t=15ms: ‚úÖ API –ê–¢–û–ú–ê–†–ù–û –º–µ–Ω—è–µ—Ç: pending -> processing
t=18ms: ‚úÖ API –∑–∞–ø—É—Å–∫–∞–µ—Ç processSongGeneration() #1
t=20ms: Webhook –æ—Ç YooKassa –ø—Ä–∏—Ö–æ–¥–∏—Ç
t=22ms: Webhook –≤—ã–∑—ã–≤–∞–µ—Ç /api/song/process
t=25ms: ‚ùå API –≤–∏–¥–∏—Ç status=processing (–ë–õ–û–ö–ò–†–£–ï–¢!)
t=26ms: ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É 400: "–ó–∞–∫–∞–∑ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–æ–ª—å–∫–æ **–æ–¥–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è** –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è! üéâ

## üìä –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ UI

–ó–∞–æ–¥–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/order/[id]`:

### –ë—ã–ª–æ:
- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ø–æ–∫–∞–∑—ã–≤–∞–ª —Å—Ç–∞—Ç–∏—á–Ω—ã–µ —à–∞–≥–∏
- –ù–µ –±—ã–ª–æ –≤–∏–¥–Ω–æ, —á—Ç–æ —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–Ω–∞ "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è"

### –°—Ç–∞–ª–æ:
- ‚úÖ –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –Ω–∞ —à–∞–≥–µ "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è" (–ø—É–ª—å—Å–∞—Ü–∏—è + –ø–æ–≤–æ—Ä–æ—Ç)
- ‚úÖ –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Ü–≤–µ—Ç–æ–≤:
  - –ó–µ–ª—ë–Ω—ã–π ‚úì (–∑–∞–≤–µ—Ä—à–µ–Ω–æ)
  - –§–∏–æ–ª–µ—Ç–æ–≤—ã–π üéµ (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π!)
  - –°–µ—Ä—ã–π ‚ö™ (–æ–∂–∏–¥–∞–Ω–∏–µ)
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–Ω—è—Ç–Ω–æ, –∫–∞–∫–æ–π —ç—Ç–∞–ø —Å–µ–π—á–∞—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:

1. –°–¥–µ–ª–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –æ–ø–ª–∞—Ç—É –Ω–∞ `/test`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ - –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å **—Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞** —Å—Ç—Ä–æ–∫–∞:
   ```
   [orderId] –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ processing, –∑–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
   ```
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Gen-API Dashboard:
   - ChatGPT: **1 –∑–∞–ø—Ä–æ—Å** (–Ω–µ 2!)
   - Suno: **1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è** (–Ω–µ 2!)
4. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/order/[id]` –¥–æ–ª–∂–Ω–∞ **–ø—É–ª—å—Å–∏—Ä–æ–≤–∞—Ç—å** –∏–∫–æ–Ω–∫–∞ "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è"

## üìù –ö–æ–º–º–∏—Ç

**Commit:** `099d223`
**–ó–∞–≥–æ–ª–æ–≤–æ–∫:** `fix: Prevent duplicate song generation and add animated progress bar`

## üí∞ –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- –ö–∞–∂–¥—ã–π –∑–∞–∫–∞–∑ = 2 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–¥–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ~$0.50 (ChatGPT + Suno)
- **–ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥: 100%** –æ—Ç –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- –ö–∞–∂–¥—ã–π –∑–∞–∫–∞–∑ = 1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
- **–≠–∫–æ–Ω–æ–º–∏—è: 50%** –Ω–∞ –∫–∞–∂–¥–æ–º –∑–∞–∫–∞–∑–µ

**–ü—Ä–∏ 100 –∑–∞–∫–∞–∑–∞—Ö/–º–µ—Å—è—Ü:**
- –ë—ã–ª–æ: $100
- –°—Ç–∞–ª–æ: $50
- **–≠–∫–æ–Ω–æ–º–∏—è: $50/–º–µ—Å—è—Ü** üí∏

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–ü—Ä–æ–±–ª–µ–º–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞** - –≤–ª–∏—è–µ—Ç –Ω–∞ —Ñ–∏–Ω–∞–Ω—Å—ã –Ω–∞–ø—Ä—è–º—É—é!
2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ** - –Ω–µ –º–µ–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É, —Ç–æ–ª—å–∫–æ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç race condition
3. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Å—Ç–∞—Ä—ã–µ –∑–∞–∫–∞–∑—ã –Ω–µ –ø–æ—Å—Ç—Ä–∞–¥–∞—é—Ç
4. **Webhook –≤—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ—Ç** - –ø—Ä–æ—Å—Ç–æ –ø–æ–ª—É—á–∏—Ç 400 –µ—Å–ª–∏ –≤–∏–¥–∂–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–ª –ø–µ—Ä–≤—ã–º

## üéØ –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**30.12.2025, 04:30 –ú–°–ö**
